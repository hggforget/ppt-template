\usepackage[left=2.5cm,
right=2.5cm,
top=2.3cm,
bottom=2.3cm,
headheight=20pt,
headsep=10pt,
footskip=15pt,
% showframe,
letterpaper]{geometry}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage[english]{babel}
\usepackage{xcolor}
\usepackage{url}
\usepackage{amsfonts}
\usepackage{nicefrac}
\usepackage{microtype}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{mathtools}
\usepackage{subcaption}
\usepackage{ragged2e}
\usepackage{stackengine}
\usepackage{etoolbox}
\usepackage{xspace}
\usepackage{xpatch}
\usepackage{cuted}
\usepackage{enumerate}
\usepackage{xstring}
\usepackage{natbib}
\usepackage{setspace}
\usepackage{makecell}
\usepackage{graphicx}
\usepackage{changepage}
\usepackage{enumitem}
\usepackage{eqparbox}
\usepackage{wrapfig}
\usepackage[hang,flushmargin,bottom]{footmisc}
\usepackage[useregional=numeric]{datetime2}
\usepackage{pifont}
\usepackage{listings}
\usepackage{environ}
\usepackage{tabularray}
\usepackage{titlesec}
% \usepackage{tocbasic}
\usepackage{titletoc}
\usepackage{afterpage}
\usepackage{fancyhdr}
\usepackage{trimclip}
\usepackage[colorlinks]{hyperref}
\usepackage[capitalise,noabbrev,nameinlink]{cleveref}

% Fonts
\renewcommand{\rmdefault}{ptm}
\renewcommand{\sfdefault}{phv}

\hyphenation{DreamerV}

% Page layout
\renewcommand{\headrulewidth}{0pt}
\renewcommand{\footrulewidth}{0pt}
\fancyhead[L]{}
\fancyhead[C]{}
\fancyhead[R]{}
\fancyfoot[L]{}
\fancyfoot[C]{}
\fancyfoot[R]{\small\thepage}
\fancypagestyle{blank}{\fancyfoot[R]{}}
\fancypagestyle{first}{\fancyfoot[L]{\small
Correspondence to: Danijar Hafner <mail@danijar.com>
}}

% Spacing
\setlength\parindent{0pt}
\setlength\parskip{1ex plus 1ex minus 0.5ex}
\setlist[itemize]{leftmargin=1em,itemsep=0ex,topsep=0ex}
\setlength{\textfloatsep}{3ex plus 1ex minus 1ex}
\titlespacing*{\paragraph}{0pt}{0ex plus .1ex}{1ex}
\titlespacing*{\section}{0ex}{2.3ex plus .3ex minus .0ex}{.6ex plus .3ex minus .2ex}
\titlespacing*{\subsection}{0ex}{1.5ex plus .3ex minus .5ex}{.4ex plus .2ex minus .1ex}
\titlespacing*{\subsubsection}{0ex}{1.2ex plus .3ex minus .3ex}{.3ex plus .2ex minus .2ex}
% \DeclareTOCStyleEntry[beforeskip=.2em plus 1pt]{tocline}{section}

\xapptocmd\normalsize{%
\abovedisplayskip=.8em plus .2em minus .2em
\belowdisplayskip=.6em plus .1em minus .1em
\abovedisplayshortskip=.8em plus .2em minus .2em
\belowdisplayshortskip=.6em plus .1em minus .1em
}{}{}

% Formatting
\newcommand{\itempar}[1]{\item\textbf{#1}\quad}
\newcommand{\padspace}{\hspace{3.5em}}

% References
% \bibliographystyle{abbrvnat}
\bibliographystyle{unsrtnat}
\setcitestyle{numbers}
\citestyle{nature}
\renewcommand{\cite}[1]{\citep{#1}}
\newcommand{\needcite}{[?]\xspace}
\newcommand{\needcites}{[???]\xspace}
\creflabelformat{equation}{#2\textup{#1}#3}
\crefname{algocf}{Algorithm}{Algorithms}
\Crefname{algocf}{Algorithm}{Algorithms}

% Link colors
\definecolor{mydarkblue}{rgb}{0.0,0.15,0.7}
\hypersetup{%
colorlinks=true,
linkcolor=mydarkblue,
citecolor=mydarkblue,
filecolor=mydarkblue,
urlcolor=mydarkblue}

% Figures and tables
\setcounter{topnumber}{1}
\setcounter{bottomnumber}{1}
\setcounter{totalnumber}{2}
\graphicspath{{figures/}}
\renewcommand{\arraystretch}{1}
\renewcommand{\topfraction}{.8}
\renewcommand{\bottomfraction}{.8}
\renewcommand{\floatpagefraction}{.8}
\makeatletter
\def\hlinewd#1{%
\noalign{\ifnum0=`}\fi\hrule \@height #1 \futurelet
\reserved@a\@xhline}
\makeatother
\captionsetup{labelfont=bf}
\newcommand{\sidecaption}[4]{%
\begin{minipage}[t]{#1}\vspace*{0pt}#3\end{minipage}\hfill%
\begin{minipage}[t]{#2}\vspace*{0pt}#4\end{minipage}}

% Tables
\UseTblrLibrary{booktabs}
\NewColumnType{L}[1]{Q[l,#1]}
\NewColumnType{C}[1]{Q[c,#1]}
\NewColumnType{R}[1]{Q[r,#1]}
\renewcommand{\o}{\hphantom{0}}
\NewEnviron{mytabular}[1]{%
  \setlength\heavyrulewidth{1.2pt}
  \setlength\lightrulewidth{.5pt}
  \setlength\aboverulesep{.4ex}%
  \setlength\belowrulesep{.8ex}%
  \begin{booktabs}[expand=\BODY]{#1}
    \BODY
  \end{booktabs}
}

% TODOs
\makeatletter
\DeclareDocumentCommand\todo{g}{%
\def\@message{\IfNoValueTF{#1}{TODO}{TODO: #1}}
\textbf{\textcolor[HTML]{FF8811}{\@message}}
\@latex@warning{\@message}{}{}}
\makeatother

% Alignment
\newcommand{\tlap}[1]{\vbox to 0pt{\vss\hbox{#1}}}
\newcommand{\blap}[1]{\vbox to 0pt{\hbox{#1}\vss}}

% Basic notation
\DeclareMathOperator*{\argmax}{arg\,max}
\DeclareMathOperator*{\argmin}{arg\,min}
\renewcommand\d{\mathop{}\!\textnormal{\slshape d}}
\newcommand\eye{\mathop{}\!\mathbb{I}}
\newcommand\defined{\doteq}
\newcommand\upto{\stackrel{+}{=}}
\newcommand\without{\setminus}
\newcommand{\describe}[3][0pt]{\hspace*{.12em}\underbracket[0.5pt][1pt]{#2\hspace*{#1}}_\text{#3}}
\newcommand{\describel}[2]{\Shortunderstack[l]{$\underbracket[1pt][0pt]{#1}$ \raisebox{.8ex}{\scriptsize\rlap{#2}}}}
\newcommand{\changes}[1]{\underbracket[1pt][0pt]{#1}}

% Equation
\makeatletter
\newcommand{\removeParBefore}{\ifvmode\vspace*{-\baselineskip}\setlength{\parskip}{0ex}\fi}
\newcommand{\removeParAfter}{\@ifnextchar\par\@gobble\relax}
\newcommand{\eq}{\begingroup\removeParBefore\endlinechar=32 \eqinner}
\newcommand{\eqinner}[2][aligned]{\endlinechar=32%
\begin{gather}\begin{#1}#2\end{#1}\end{gather}\endgroup\removeParAfter}
\makeatother

% Density
\DeclareDocumentCommand{\p}{ D<>{p} D<>{} r() }{
\def\content{#3}\patchcmd{\content}{|}{\;#2\vert\;}{}{}
\ensuremath{#1 #2(\content #2)}}

% Probability
\DeclareDocumentCommand{\P}{ D<>{P} D<>{\big} r() }{
\def\content{#3}\patchcmd{\content}{|}{\;#2\vert\;}{}{}
\ensuremath{\operatorname{#1}#2(\content #2)}}

% Expectation
\DeclareDocumentCommand{\E}{ D<>{E} E{_}{{}} D<>{\big} r[] }{
\def\content{#4}\patchcmd{\content}{|}{\;#3\vert\;}{}{}
\ensuremath{\operatorname{#1}_{#2}#3[\content #3]}}

% Divergence
\DeclareDocumentCommand{\D}{ D<>{D} D<>{\big} r[] }{
\def\content{#3}\patchcmd{\content}{||}{\;#2\|\;}{}{}
\ensuremath{\operatorname{#1}\!#2[\content #2]}}

% Distributions
\NewDocumentCommand{\Nor}{ r() }{\P<Normal>](#1)}
\NewDocumentCommand{\Cat}{ r() }{\P<Cat>](#1)}
\NewDocumentCommand{\Bin}{ r() }{\P<Bin>](#1)}
\NewDocumentCommand{\Bet}{ r() }{\P<Beta>](#1)}
\NewDocumentCommand{\Ber}{ r() }{\P<Bernoulli>(#1)}
\NewDocumentCommand{\Dir}{ r() }{\P<Dir>(#1)}

% Information
\DeclareDocumentCommand{\KL}{ D<>{\big} r[] }{\D<KL><#1>[#2]}
\DeclareDocumentCommand{\H}{ D<>{\big} r[] }{\E<H><#1>[#2]}
\DeclareDocumentCommand{\I}{ D<>{\big} r[] }{\E<I><#1>[#2]}

% Symbols
\newcommand{\cmark}{\textcolor{green}{\ding{51}}}
\newcommand{\xmark}{\textcolor{red}{\ding{55}}}

% Shortcuts
\DeclareDocumentCommand{\lnpp}{ D<>{} r() }{
\ensuremath{\p<\ln p_\phi><#1>(#2)}}
\DeclareDocumentCommand{\pp}{ D<>{} r() }{
\ensuremath{\p<p_\phi><#1>(#2)}}
\DeclareDocumentCommand{\qp}{ D<>{} r() }{
\ensuremath{\p<q_\phi><#1>(#2)}}
\DeclareDocumentCommand{\SymLogNormal}{ D<>{} r() }{
\ensuremath{\p<\operatorname{SymLogNormal}><#1>(#2)}}
\newcommand{\sign}{\operatorname{sign}}
\newcommand{\abs}{\operatorname{abs}}
\newcommand{\eps}{\epsilon}
\newcommand{\erf}{\operatorname{erf}}
\newcommand{\fot}{\textstyle\frac{1}{2}}
\newcommand{\symlog}{\ensuremath{\operatorname{symlog}}}
\newcommand{\symexp}{\ensuremath{\operatorname{symexp}}}
\newcommand{\twohot}{\ensuremath{\operatorname{twohot}}}
\newcommand{\sg}{\ensuremath{\operatorname{sg}}}
